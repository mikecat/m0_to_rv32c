# `m0_to_rv32c.pl`

## レジスタの割り当て

|M0|RV32C|保存責任|使い方|
|---|---|---|---|
|R0～R3|R10～R13|caller-save|引数と戻り値|
|R4、R5|R8、R9|callee-save|汎用 (RV32Cの演算命令で使いやすい)|
|R6～R11|R18～R23|callee-save|汎用|
|R12|R14|caller-save|汎用|
|R13|R2|callee-save|スタックポインタ|
|R14|R1|caller-save|リンクレジスタ|
|R15|R15|caller-save (RV32C)|プログラムカウンタ / RV32Cでは作業用|
|-|R28|caller-save|メモリアクセス作業用|
|-|R29～R31|caller-save|分岐作業用(仮)|
|-|R5～R7、R16、R17|caller-save|未割り当て|
|-|R24～R27|callee-save|未割り当て|

参考：

* [楽しさ広がるマルチバイトメモリアクセスとスタック - IchigoJamではじめるArmマシン語その5](https://fukuno.jig.jp/1479)
* [IchigoJam Rβでも輝くWS2812B、RISC-Vマシン語で10ナノ秒単位で制御する](https://fukuno.jig.jp/3111)

## M0でレジスタの指定が4ビットの命令

### ドキュメントの確認

M0命令セットでレジスタの指定が4ビットの命令について、UM10398を参照してPCとの関係を調べる。

```
Rd = Rm
```

`MOV Rd, Rm` 命令に相当。  
RdもRmもR0-R7しか指定できないとしつつ、RdがPCのときの挙動も書かれていて謎。  
RdがPCのとき、LSBを0にしたアドレスに分岐する。  
RmがPCのときは不明。

```
Rd += Rm
```

`ADD Rn, Rm` 命令に相当。  
RnとRmの両方をPCにしてはいけないとされる。

```
Rn - Rm
```

`CMP Rn, Rm` 命令に相当。  
RnとRmにR0-R14を指定できるとなっており、PC (R15) は使えなそうである。

```
GOTO Rm
```

`BX Rm` 命令に相当。  
SPやPCを使ってはいけないとされる。

```
GOSUB Rm
```

`BLX Rm` 命令に相当。  
SPやPCを使ってはいけないとされる。

## 実機の動作の確認

IchigoKamuy (IchigoJam BASIC 1.4.1) を用い、各命令の動作を確かめる。  
なお、このバージョンでは、`USR`によるマシン語の呼び出し時、第2引数にRAMの0番地相当のアドレスが入る。

※IchigoJamはjig.jpの登録商標です。  
※IchigoKamuyは株式会社syushuの登録商標です。

```
GOTO R15
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,120,71,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`3` が出力された。  
`GOTO` の2個次の命令に飛んでいそうだ。

```
R3 = R14
GOSUB R15
R0 += 1
R0 += 1
R0 += 1
R0 += 1
GOTO R3
```

```
10 POKE#700,115,70,248,71,1,48,1,48,1,48,1,48,24,71
20 ?USR(#700,0)
```

`3` が出力された。  
`GOSUB` の2個次の命令に飛んでいそうだ。

```
R15 - R15
RET
```

```
10 POKE#700,255,69,112,71
20 ?USR(#700,0)
```

`0` が出力された。  
`CMP` でR15を指定してもエラーにはならないようだ。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #C
R15 - R3
IF 0 GOTO @MATCHED
R0 = 1
RET
@MATCHED
R0 = 0
RET
```

```
10 POKE#700,7,34,18,2,139,24,12,51,159,69,1,208,1,32,112,71,0,32,112,71
20 ?USR(#700,0)
```

`0` が出力された。  
`CMP` 命令での `R15` は2命令先のアドレスが使われるようだ。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #C
R3 - R15
IF 0 GOTO @MATCHED
R0 = 1
RET
@MATCHED
R0 = 0
RET
```

```
10 POKE#700,7,34,18,2,139,24,12,51,123,69,1,208,1,32,112,71,0,32,112,71
20 ?USR(#700,0)
```

`CMP` 命令のオペランドを入れ替えても、 `0` が出力された。

```
R3 = 1
R15 += R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,1,35,159,68,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`3` が出力された。  
`R15 += R3` の2個次の命令に飛んだようだ。

```
R3 = 2
R15 += R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,2,35,159,68,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`2` が出力された。  
`R15 += R3` の2個次の命令の次の命令に飛んだようだ。

```
R3 = 3
R15 += R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,3,35,159,68,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`2` が出力された。  
`R15 += R3` の2個次の命令の次の命令に飛んだようだ。

```
R0 += R15
R0 = R0 - R1
RET
```

```
10 POKE#700,120,68,64,26,112,71
20 ?HEX$(USR(#700,0))
30 ?HEX$(USR(#700,1))
40 ?HEX$(USR(#700,2))
```

`704 705 706` (実際には改行区切り) が出力された。
`R0 += R15` の2個次の命令のアドレスが足されるようだ。

```
R15 += R15
RET
```

```
10 POKE#700,255,68,112,71
20 ?USR(#700,0)
```

`Segmentation Fault in 20` が出力された。  
変なアドレスに飛んだためか、無効な命令扱いされたのかは不明。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #10
R15 = R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,7,34,18,2,139,24,16,51,159,70,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`1` が出力された。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #11
R15 = R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,7,34,18,2,139,24,17,51,159,70,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`1` が出力された。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #10
GOTO R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,7,34,18,2,139,24,16,51,24,71,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`Segmentation Fault in 20` が出力された。

```
R2 = 7
R2 = R2 << 8
R3 = R1 + R2
R3 += #11
GOTO R3
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,7,34,18,2,139,24,17,51,24,71,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`1` が出力された。

`GOTO R3` 命令ではLSBが0だとエラーになる一方、 `R15 = R3` 命令ではLSBが0でもエラーにならないようだ。

```
R0 = R15
R0 = R0 - R1
RET
```

```
10 POKE#700,120,70,64,26,112,71
20 ?HEX$(USR(#700,0))
```

`704` が出力された。  
2個次の命令のアドレスが使われるようだ。

```
R15 = R15
R0 += 1
R0 += 1
R0 += 1
R0 += 1
RET
```

```
10 POKE#700,255,70,1,48,1,48,1,48,1,48,112,71
20 ?USR(#700,0)
```

`3` が出力された。  
2個次の命令に飛んでいるようだ。

### 実装方針

調査結果を踏まえ、今回は以下の仕様とする。

```
R15 - Rm
Rn - R15
R15 - R15
GOTO R15
GOSUB R15
R15 += R15
```

UM10398に使えないと書かれており、使う意味も薄そうなので、対応しない。

```
R15 = R15
R15 += Rm
```

使う意味が薄そうであり、命令の変換によりさらに意味が狂うと考えられるので、対応しない。

```
Rd = R15
Rd += R15
```

PCを取得してオフセットを加える命令に変換する。

```
R15 = Rm
```

`GOTO Rm` と比べてLSBを無視できる利点があるため、 `GOTO Rs` 命令に変換する。
